<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced CSP Index Page</title>
    
    <!-- CRITICAL: Load MSAL FIRST before any auth scripts -->
    
    <!-- Then load the auth wrapper -->
    
    <!-- Your other stylesheets and scripts -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #7f8c8d;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .page-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .page-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .page-card h3 {
            margin: 0 0 1rem 0;
            color: #495057;
        }

        .page-card p {
            margin: 0 0 1rem 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .page-link {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .page-link:hover {
            background: #0056b3;
        }

        .auth-status {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
    <!-- CSP Local Authentication Protection -->
    <script src="../js/auth-protection.js"></script>
    <style>
        /* Authentication header styles */
        #csp-auth-header {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Page content adjustment for auth header */
        body.auth-protected {
            padding-top: 60px;
        }
        
        /* Loading indicator */
        .auth-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .auth-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
<body>
    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading authentication...</p>
    </div>

    <!-- Main content (hidden until auth is ready) -->
    <div id="main-content" style="display: none;">
        <div class="container">
            <div class="auth-status" id="auth-status">
                <p id="user-info">üîê Checking authentication...</p>
            </div>

            <div class="header">
                <h1>üöÄ Enhanced CSP Index Page</h1>
                <p>Welcome to the Enhanced CSP System</p>
            </div>

            <div class="pages-grid" id="pages-grid">
                <!-- Pages will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Authentication Ready Handler -->
    <script>
        console.log('üöÄ Initializing Enhanced CSP Index Page');

        // Show loading initially
        document.getElementById('loading').style.display = 'block';

        document.addEventListener('cspAuthReady', (event) => {
            console.log('üéâ Page authenticated and ready:', event.detail);
            
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Update auth status
            const userInfo = document.getElementById('user-info');
            const user = event.detail.user;
            userInfo.innerHTML = `‚úÖ Welcome, ${user.name || user.email || 'User'}! (${user.role || 'No role'})`;
            
            // Load available pages
            loadAvailablePages();
        });
        
        document.addEventListener('cspAuthError', (event) => {
            console.error('‚ùå Authentication error:', event.detail);
            
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            
            // Show error message
            document.body.innerHTML = `
                <div class="container">
                    <div class="auth-status" style="background: #ffebee; border-color: #ffcdd2;">
                        <h2>‚ùå Authentication Error</h2>
                        <p>${event.detail.message || 'Failed to authenticate'}</p>
                        <p><a href="/pages/login.html">Go to Login</a></p>
                    </div>
                </div>
            `;
        });

        function loadAvailablePages() {
            console.log('üîç Scanning available pages...');
            
            const pagesGrid = document.getElementById('pages-grid');
            
            // Available pages in the system
            const pages = [
                {
                    name: 'Admin Portal',
                    description: 'Main administrative dashboard for system management',
                    url: '../csp_admin_portal.html',
                    icon: '‚öôÔ∏è'
                },
                {
                    name: 'AI Agents',
                    description: 'Manage and monitor AI agents in the network',
                    url: 'ai-agents.html',
                    icon: 'ü§ñ'
                },
                {
                    name: 'Monitoring',
                    description: 'Real-time system monitoring and analytics',
                    url: 'monitoring.html',
                    icon: 'üìä'
                },
                {
                    name: 'Web Dashboard',
                    description: 'Web interface dashboard for data visualization',
                    url: 'web_dashboard_ui.html',
                    icon: 'üåê'
                },
                {
                    name: 'Settings',
                    description: 'System configuration and user preferences',
                    url: 'settings.html',
                    icon: '‚öôÔ∏è'
                },
                {
                    name: 'Login',
                    description: 'Authentication and user login page',
                    url: 'login.html',
                    icon: 'üîê'
                }
            ];

            pagesGrid.innerHTML = pages.map(page => `
                <div class="page-card">
                    <h3>${page.icon} ${page.name}</h3>
                    <p>${page.description}</p>
                    <a href="${page.url}" class="page-link">Open Page</a>
                </div>
            `).join('');
        }

        // Fallback if authentication takes too long
        setTimeout(() => {
            if (document.getElementById('loading').style.display !== 'none') {
                console.warn('‚ö†Ô∏è Authentication taking longer than expected...');
                
                // Show a different message
                document.getElementById('loading').innerHTML = `
                    <div class="spinner"></div>
                    <p>Authentication is taking longer than expected...</p>
                    <p><a href="/pages/login.html">Go to Login Page</a></p>
                `;
            }
        }, 10000); // 10 seconds
    </script>
</body>
    <!-- Authentication Event Handlers -->
    <script>
        // Show loading indicator while auth initializes
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.location.pathname.includes('login.html')) {
                const loader = document.createElement('div');
                loader.className = 'auth-loading';
                loader.innerHTML = `
                    <div class="auth-spinner"></div>
                    <div>üîê Initializing Authentication...</div>
                `;
                document.body.appendChild(loader);
                
                // Remove loader after auth is ready or timeout
                const removeLoader = () => {
                    if (loader.parentNode) {
                        loader.parentNode.removeChild(loader);
                    }
                };
                
                // Remove on auth ready
                document.addEventListener('cspAuthReady', removeLoader);
                document.addEventListener('cspAuthError', removeLoader);
                
                // Remove after timeout
                setTimeout(removeLoader, 10000);
            }
        });
        
        // Authentication ready event
        document.addEventListener('cspAuthReady', (event) => {
            console.log('üéâ Page authenticated and ready:', event.detail);
            document.body.classList.add('auth-protected');
            
            // Page-specific initialization can go here
            if (typeof onAuthReady === 'function') {
                onAuthReady(event.detail);
            }
        });
        
        // Authentication error event
        document.addEventListener('cspAuthError', (event) => {
            console.error('‚ùå Authentication error:', event.detail);
            
            // Page-specific error handling
            if (typeof onAuthError === 'function') {
                onAuthError(event.detail);
            }
        });
        
        // Session expired event
        document.addEventListener('cspSessionExpired', (event) => {
            console.warn('‚è∞ Session expired:', event.detail);
            
            // Page-specific session expiry handling
            if (typeof onSessionExpired === 'function') {
                onSessionExpired(event.detail);
            }
        });
    </script>
